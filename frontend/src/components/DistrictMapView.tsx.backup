import React, { useState, useMemo, useEffect } from 'react';
import { MapContainer, TileLayer, CircleMarker, Popup, useMap } from 'react-leaflet';
import { District } from '../data/types';
import LocationPins from './LocationPins';
import { Meter } from '../data/types';
import L from 'leaflet';
import 'leaflet/dist/leaflet.css';

// âœ… Import heatmap - needs to be added to window.L
declare global {
  interface Window {
    L: any;
  }
}

interface DistrictMapViewProps {
  districts: District[];
  onDistrictClick: (districtId: string) => void;
  selectedDistrict: string | null;
  meters?: Meter[];
  onMeterClick?: (meter: Meter) => void;
}

// âœ… NCR Center - Focus on Manila
const NCR_CENTER: [number, number] = [14.5995, 121.0374];
const INITIAL_ZOOM = 12;

// âœ… ONLY Manila City - since data only has Manila
const MANILA_CITY = {
  id: 'manila',
  name: 'Manila',
  center: [14.5995, 121.0374] as [number, number],
};

const NCR_BOUNDS: L.LatLngBoundsLiteral = [
  [14.3800, 120.9200],
  [14.7500, 121.1200],
];

/**
 * Haversine formula to calculate distance between two coordinates in meters
 * Source: https://en.wikipedia.org/wiki/Haversine_formula
 */
const calculateDistance = (
  lat1: number,
  lon1: number,
  lat2: number,
  lon2: number
): number => {
  const R = 6371e3; // Earth's radius in meters
  const Ï†1 = (lat1 * Math.PI) / 180;
  const Ï†2 = (lat2 * Math.PI) / 180;
  const Î”Ï† = ((lat2 - lat1) * Math.PI) / 180;
  const Î”Î» = ((lon2 - lon1) * Math.PI) / 180;

  const a =
    Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
    Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

  return R * c; // Distance in meters
};

/**
 * Detect high-risk clusters using distance-based logic
 * Returns true if there's a cluster of 3+ high-risk meters within specified distance
 * 
 * Research notes:
 * - Typical distribution transformer serves 300-500m radius
 * - Urban jumper wire clusters usually within 200-400m
 * - Using 350m as sweet spot for detecting neighborhood-level anomalies
 */
const hasHighRiskCluster = (meters: Meter[], maxDistance: number = 350): boolean => {
  const highRiskMeters = meters.filter(m => m.riskLevel === 'high');
  
  if (highRiskMeters.length < 3) {
    console.log(`âš ï¸ Only ${highRiskMeters.length} high-risk meters, need at least 3 for cluster`);
    return false;
  }

  // For each high-risk meter, count how many other high-risk meters are within distance
  for (let i = 0; i < highRiskMeters.length; i++) {
    const [lat1, lon1] = highRiskMeters[i].position;
    let nearbyCount = 0;

    for (let j = 0; j < highRiskMeters.length; j++) {
      if (i === j) continue; // Skip same meter

      const [lat2, lon2] = highRiskMeters[j].position;
      const distance = calculateDistance(lat1, lon1, lat2, lon2);

      if (distance <= maxDistance) {
        nearbyCount++;
      }
    }

    // If this meter has 2+ neighbors within distance, we have a cluster of 3+
    if (nearbyCount >= 2) {
      console.log(`âœ… Cluster detected! Meter ${highRiskMeters[i].meterNumber} has ${nearbyCount} neighbors within ${maxDistance}m`);
      return true;
    }
  }

  console.log(`âš ï¸ No clusters found. High-risk meters too spread out (>${maxDistance}m apart)`);
  return false;
};

// âœ… Heatmap Component
const HeatmapLayer: React.FC<{ meters: Meter[] }> = ({ meters }) => {
  const map = useMap();

  useEffect(() => {
    const loadHeatmap = async () => {
      if (!window.L.heatLayer) {
        // @ts-ignore
        await import('leaflet.heat');
      }

      if (!meters || meters.length === 0) return;

      const highRiskMeters = meters.filter(m => m.riskLevel === 'high');
      
      console.log('ğŸ”¥ High risk meters for heatmap:', highRiskMeters.length);

      if (highRiskMeters.length === 0) {
        console.log('âš ï¸ No high-risk meters to display');
        return;
      }

      const heatData = highRiskMeters.map(meter => [
        meter.position[0],
        meter.position[1],
        meter.anomalyScore,
      ]);

      console.log('ğŸ“Š Heatmap data points:', heatData.length);

      // @ts-ignore
      const heatLayer = L.heatLayer(heatData, {
        radius: 30,
        blur: 20,
        maxZoom: 17,
        max: 1.0,
        minOpacity: 0.4,
        gradient: {
          0.0: 'blue',
          0.2: 'lime',
          0.4: 'yellow',
          0.6: 'orange',
          0.8: 'red',
          1.0: 'darkred',
        },
      }).addTo(map);

      console.log('âœ… Heatmap layer added to map');

      return () => {
        console.log('ğŸ—‘ï¸ Removing heatmap layer');
        map.removeLayer(heatLayer);
      };
    };

    loadHeatmap();
  }, [map, meters]);

  return null;
};

// Map Controller
const MapController: React.FC<{ center: [number, number]; zoom: number }> = ({ center, zoom }) => {
  const map = useMap();

  React.useEffect(() => {
    map.flyTo(center, zoom, {
      duration: 1.2,
      easeLinearity: 0.25,
    });
  }, [center, zoom, map]);

  return null;
};

type ViewLevel = 'city' | 'barangay';

interface ViewState {
  level: ViewLevel;
}

const DistrictMapView: React.FC<DistrictMapViewProps> = ({
  districts,
  onDistrictClick,
  selectedDistrict,
  meters = [],
  onMeterClick,
}) => {
  const [mapCenter, setMapCenter] = useState<[number, number]>(NCR_CENTER);
  const [mapZoom, setMapZoom] = useState(INITIAL_ZOOM);
  const [viewState, setViewState] = useState<ViewState>({
    level: 'city', // âœ… Start at city level - show Manila
  });

  const getRiskColor = (riskLevel: 'high' | 'medium' | 'low') => {
    switch (riskLevel) {
      case 'high': return '#FF6F00';
      case 'medium': return '#FFA500';
      case 'low': return '#90EE90';
      default: return '#CCCCCC';
    }
  };

  // âœ… Calculate Manila stats
  const getManilaStats = () => {
    const highRiskCount = meters.filter(m => m.riskLevel === 'high').length;
    const mediumRiskCount = meters.filter(m => m.riskLevel === 'medium').length;
    const lowRiskCount = meters.filter(m => m.riskLevel === 'low').length;
    
    const riskLevel: 'high' | 'medium' | 'low' = 
      highRiskCount > meters.length * 0.3 ? 'high' :
      highRiskCount > meters.length * 0.1 ? 'medium' : 'low';

    return {
      totalMeters: meters.length,
      highRisk: highRiskCount,
      mediumRisk: mediumRiskCount,
      lowRisk: lowRiskCount,
      riskLevel,
    };
  };

  // âœ… Click Manila - Zoom into barangays
  const handleManilaClick = () => {
    setMapCenter(MANILA_CITY.center);
    setMapZoom(14); // Zoom closer to show barangays
    setViewState({
      level: 'barangay',
    });
    onDistrictClick('manila');
  };

  // âœ… Reset to city view
  const handleResetView = () => {
    setMapCenter(NCR_CENTER);
    setMapZoom(INITIAL_ZOOM);
    setViewState({
      level: 'city',
    });
    onDistrictClick('');
  };

  // âœ… Check if heatmap should be shown - Distance-based clustering
  const showHeatmap = useMemo(() => {
    if (viewState.level !== 'barangay') return false; // Only show heatmap at barangay level

    const shouldShow = hasHighRiskCluster(meters, 350); // 350m threshold
    
    if (shouldShow) {
      const highRiskCount = meters.filter(m => m.riskLevel === 'high').length;
      console.log(`ğŸ”¥ HEATMAP ENABLED: Detected cluster of ${highRiskCount} high-risk meters within 350m`);
    } else {
      console.log(`âŒ HEATMAP DISABLED: No clusters detected (meters too spread out)`);
    }
    
    return shouldShow;
  }, [meters, viewState]);

  const stats = getManilaStats();

  return (
    <div className="relative h-full w-full">
      {/* Back Button */}
      {viewState.level === 'barangay' && (
        <button
          onClick={handleResetView}
          className="absolute top-4 left-4 z-[1000] bg-white px-4 py-2 rounded-lg shadow-lg hover:bg-gray-100 hover:shadow-xl transition-all duration-300 flex items-center gap-2 animate-fadeIn"
        >
          â† Back to Manila City
        </button>
      )}

      {/* View Level Indicator */}
      <div className="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] bg-white px-4 py-2 rounded-lg shadow-lg">
        <p className="text-sm font-medium text-gray-700">
          {viewState.level === 'city' && 'ğŸ™ï¸ Manila City'}
          {viewState.level === 'barangay' && 'ğŸ“ Manila - Barangay View'}
          {showHeatmap && ' â€¢ ğŸ”¥ High Risk Heatmap Active'}
        </p>
      </div>

      <MapContainer
        center={NCR_CENTER}
        zoom={INITIAL_ZOOM}
        style={{ height: '100%', width: '100%' }}
        zoomControl={true}
        maxBounds={NCR_BOUNDS}
        maxBoundsViscosity={1.0}
        minZoom={12}
        maxZoom={18}
        scrollWheelZoom={true}
        doubleClickZoom={true}
        dragging={true}
        zoomAnimation={true}
        fadeAnimation={true}
        markerZoomAnimation={true}
      >
        <MapController center={mapCenter} zoom={mapZoom} />
        
        <TileLayer
          attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
          updateWhenIdle={false}
          keepBuffer={4}
        />

        {/* LEVEL 1: Show Manila City Pin */}
        {viewState.level === 'city' && (
          <CircleMarker
            center={MANILA_CITY.center}
            radius={50} // Large pin for Manila
            pathOptions={{
              fillColor: getRiskColor(stats.riskLevel),
              fillOpacity: 0.6,
              color: '#FFFFFF',
              weight: 4,
            }}
            eventHandlers={{
              click: handleManilaClick,
            }}
          >
            <Popup>
              <div className="p-4 min-w-[250px]">
                <h3 className="font-bold text-2xl text-meralco-black mb-3">Manila City</h3>
                <div className="space-y-2 text-sm mb-4">
                  <p className="flex justify-between">
                    <strong>Total Meters:</strong> 
                    <span className="font-semibold">{stats.totalMeters}</span>
                  </p>
                  <p className="flex justify-between">
                    <strong className="text-red-600">High Risk:</strong> 
                    <span className="font-semibold text-red-600">{stats.highRisk}</span>
                  </p>
                  <p className="flex justify-between">
                    <strong className="text-yellow-600">Medium Risk:</strong> 
                    <span className="font-semibold text-yellow-600">{stats.mediumRisk}</span>
                  </p>
                  <p className="flex justify-between">
                    <strong className="text-green-600">Low Risk:</strong> 
                    <span className="font-semibold text-green-600">{stats.lowRisk}</span>
                  </p>
                  <hr className="my-2" />
                  <p className="flex justify-between">
                    <strong>Overall Risk:</strong> 
                    <span className={`font-bold ${
                      stats.riskLevel === 'high' ? 'text-red-600' :
                      stats.riskLevel === 'medium' ? 'text-yellow-600' : 'text-green-600'
                    }`}>{stats.riskLevel.toUpperCase()}</span>
                  </p>
                </div>
                <button
                  onClick={handleManilaClick}
                  className="w-full bg-meralco-orange text-white px-4 py-3 rounded-lg hover:bg-opacity-90 transition-all font-medium shadow-md"
                >
                  View Barangays â†’
                </button>
              </div>
            </Popup>
          </CircleMarker>
        )}

        {/* LEVEL 2: Show Barangay Meters + Heatmap */}
        {viewState.level === 'barangay' && (
          <>
            {/* âœ… Heatmap shows if high-risk meters exist */}
            {showHeatmap && (
              <>
                {console.log('ğŸ”¥ Rendering heatmap component')}
                <HeatmapLayer meters={meters} />
              </>
            )}
            
            {/* Individual meter pins */}
            {meters.length > 0 && onMeterClick && (
              <div className="animate-fadeIn">
                <LocationPins 
                  meters={meters} 
                  onPinClick={onMeterClick}
                />
              </div>
            )}
          </>
        )}
      </MapContainer>

      {/* Info Panel */}
      <div className="absolute bottom-4 right-4 bg-white p-4 rounded-lg shadow-lg hover:shadow-xl z-[1000] max-w-xs transition-all duration-300">
        <h4 className="font-bold text-sm mb-2">
          {viewState.level === 'city' ? 'ğŸ—ºï¸ Manila City' : 'ğŸ“ Manila Barangays'}
        </h4>
        
        {viewState.level === 'city' && (
          <p className="text-xs text-gray-600 mb-3">
            Capital of the Philippines
          </p>
        )}

        <div className="space-y-1 text-xs mb-3">
          <div className="flex items-center justify-between gap-2">
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded-full" style={{ backgroundColor: '#FF6F00' }}></div>
              <span>High Risk</span>
            </div>
            <span className="font-semibold">{stats.highRisk}</span>
          </div>
          <div className="flex items-center justify-between gap-2">
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded-full" style={{ backgroundColor: '#FFA500' }}></div>
              <span>Medium Risk</span>
            </div>
            <span className="font-semibold">{stats.mediumRisk}</span>
          </div>
          <div className="flex items-center justify-between gap-2">
            <div className="flex items-center gap-2">
              <div className="w-4 h-4 rounded-full" style={{ backgroundColor: '#90EE90' }}></div>
              <span>Low Risk</span>
            </div>
            <span className="font-semibold">{stats.lowRisk}</span>
          </div>
        </div>

        <div className="pt-3 border-t border-gray-200">
          <p className="text-xs text-gray-600 font-medium">
            ğŸ“ Total Meters: <span className="font-bold text-meralco-black">{stats.totalMeters}</span>
          </p>
          {viewState.level === 'barangay' && showHeatmap && (
            <p className="text-xs text-orange-600 mt-2">
              ğŸ”¥ Heatmap: {stats.highRisk} high-risk clusters detected
            </p>
          )}
        </div>

        {viewState.level === 'city' && (
          <p className="mt-3 pt-3 border-t border-gray-200 text-xs text-gray-500 italic">
            Click Manila to view barangays
          </p>
        )}
      </div>

      {/* CSS */}
      <style>{`
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
          animation: fadeIn 0.5s ease-out forwards;
        }
      `}</style>
    </div>
  );
};

export default DistrictMapView;

